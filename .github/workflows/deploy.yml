name: HireHub CI (Local MySQL Test)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # âœ… â‘  GitHub Actions ë‚´ì—ì„œ MySQL ì»¨í…Œì´ë„ˆ ë„ì›€
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: hirehub
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # âœ… â‘¡ Git ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # âœ… â‘¢ Java 17 ì„¤ì¹˜
      - name: âš™ï¸ Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… â‘£ MySQL ì¤€ë¹„ ëŒ€ê¸° (ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ê¸°ë‹¤ë¦¼)
      - name: â³ Wait for MySQL
        run: |
          for i in {1..15}; do
            nc -z localhost 3306 && echo "âœ… MySQL ready" && break
            echo "â³ Waiting for MySQL..."
            sleep 5
          done

      # âœ… â‘¤ Backend ë¹Œë“œ
      - name: ğŸ§© Build Backend
        working-directory: backsrc
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

      # âœ… â‘¥ Frontend ë¹Œë“œ
      - name: ğŸ§© Build Frontend
        working-directory: frontsrc
        run: |
          npm install
          npm run build

      # âœ… â‘¦ Spring Boot ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (RDS ëŒ€ì‹  ë¡œì»¬ MySQL ì—°ê²°)
      - name: âœ… Run Spring Boot Test with Local MySQL
        working-directory: backsrc
        env:
          SPRING_PROFILES_ACTIVE: aws
          DB_USERNAME: root
          DB_PASSWORD: root
          DB_URL: jdbc:mysql://localhost:3306/hirehub?serverTimezone=Asia/Seoul
          AWS_ACCESS_KEY: dummy
          AWS_SECRET_KEY: dummy
          AWS_REGION: ap-northeast-2
        run: |
          echo "ğŸš€ Starting backend for test..."
          java -jar build/libs/*SNAPSHOT.jar --spring.datasource.url=${DB_URL} --spring.datasource.username=root --spring.datasource.password=root --spring.main.web-application-type=none
