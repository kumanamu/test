name: HireHub CI (Local MySQL Test)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # âœ… â‘  MySQL ì»¨í…Œì´ë„ˆ ë„ìš°ê¸° (GitHub Actions ë‚´ì¥ ì„œë¹„ìŠ¤)
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: hirehub
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      # âœ… â‘¡ ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # âœ… â‘¢ Java 17 ì„¤ì¹˜
      - name: âš™ï¸ Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # âœ… â‘£ MySQL ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 1ë¶„)
      - name: â³ Wait for MySQL
        run: |
          for i in {1..15}; do
            nc -z localhost 3306 && echo "âœ… MySQL ready" && break
            echo "â³ Waiting for MySQL..."
            sleep 5
          done

      # âœ… â‘¤ MySQL ì—°ê²° í…ŒìŠ¤íŠ¸ (ì§„ì§œ ì ‘ì† í™•ì¸)
      - name: ğŸ§¾ Check MySQL Connection
        run: |
          sudo apt-get update && sudo apt-get install -y mysql-client
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SHOW DATABASES;"

      # âœ… â‘¥ ë°±ì—”ë“œ ë¹Œë“œ (ë£¨íŠ¸ gradlew ê¸°ì¤€)
      - name: ğŸ§© Build Backend
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test

        # âœ… â‘¦ Spring Boot ì‹¤í–‰ í…ŒìŠ¤íŠ¸ (RDS ëŒ€ì‹  ë¡œì»¬ MySQL ì‚¬ìš©)
            - name: ğŸš€ Run Spring Boot with Local MySQL
        env:
          SPRING_PROFILES_ACTIVE: aws
          DB_USERNAME: root
          DB_PASSWORD: root
          DB_URL: jdbc:mysql://localhost:3306/hirehub?serverTimezone=Asia/Seoul
          AWS_ACCESS_KEY: dummy
          AWS_SECRET_KEY: dummy
          AWS_REGION: ap-northeast-2
          GOOGLE_CLIENT_ID: dummy
          GOOGLE_SECRET: dummy
          KAKAO_CLIENT_ID: dummy
          KAKAO_CLIENT_SECRET: dummy
          NAVER_CLIENT_ID: dummy
          NAVER_CLIENT_SECRET: dummy
        run: |
          echo "ğŸš€ Starting backend for test..."
          java \
            --add-opens java.base/java.lang=ALL-UNNAMED \
            --add-opens java.base/java.lang.invoke=ALL-UNNAMED \
            --add-opens java.base/java.util=ALL-UNNAMED \
            -jar build/libs/*SNAPSHOT.jar \
            --spring.datasource.url=${DB_URL} \
            --spring.datasource.username=${DB_USERNAME} \
            --spring.datasource.password=${DB_PASSWORD} \
            --spring.main.web-application-type=none

